<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8" />
    <style>
        body {
            height: 100%;
            margin: 0;
        }

        #content {
            width: 100%;
            height: 100%;
            background-color: #f2f2f2;
        }

        #content #title {
            padding: 15px 15px 0px 15px;
            color: #222;
            font-size: 20px;
            font-family: "微软雅黑", "宋体", serif;
            font-weight: bold;
        }

        #content #description {
            padding: 15px 15px 0px 15px;
            color: #444;
            font-size: 12px;
            font-family: "微软雅黑", "宋体", serif;
        }

        #content #msg {
            width: 510px;
            height: 132px;
            word-break: break-all;
            border: 1px solid #ccc;
            margin: 15px 15px 0px 15px;
            resize: none;
        }

        #content #control {
            text-align: right;
            padding: 15px 15px 0px 15px;
        }

        button {
            min-width: 80px;
            min-height: 25px;
        }

        .hide {
            display: none;
        }
    </style>

</head>

<body>
    <div id="content">
        <div id="title">发现可更新的版本</div>
        <div id="description">
            在更新服务器中找到比目前已安装版本更新的更新包，请选择是否立即开始更新。
            <ul>
                <li>已安装版本：v<span id="oldVersion"></span></li>
                <li>待升级版本：v<span id="newVersion"></span></li>
            </ul>
        </div>
        <textarea id="msg"></textarea>
        <div id="control">
            <input id="download-filepath-selector" style="display: none;" type="file" nwsaveas="setup.exe">
            <button id="download" style="float:left" title="点击下载新版安装包，关闭此窗口会中断下载，任务栏图标显示下载进度，下载完成后请您关闭当前客户端安装新版">下载更新包</button>
            <button id="update">更新</button>
            <button id="reset" class="hide">重启</button>
            <button id="cancel">取消</button>
        </div>
    </div>
</body>
<script>
    var gui = require('nw.gui');
    var pkg = require('../package.json');
    var updater = require('node-webkit-updater');
    var ncp = require('fs-extra').copy;
    var upd = new updater(pkg);

    function $(text) {
        return document.getElementById(text);
    }

    function setParent(parentNW, manifest) {
        window.parentNW = parentNW;
        $("oldVersion").innerText = pkg.version;
        $("newVersion").innerText = manifest.version;
        $("msg").value = manifest.description;
    }

    function setText(title) {
        $('download').innerHTML = title;
    }

    function msg(text, returnFlag) {
        var messageBox = $("msg");
        if (returnFlag) {
            messageBox.value += text + "\n";
        } else {
            messageBox.value += text;
        }
        messageBox.selectionStart = messageBox.value.length
    }

    function update() {
        $("msg").value = "";
        upd.checkNewVersion(function (error, newVersionExists, newPatchExists, manifest) {
            msg("开始检查自动更新……", false);
            if (!error) {
                if (newVersionExists) {
                    msg("发现新版本", true);
                    msg("正在下载更新包……", false);
                    $("update").disabled = "true";
                    upd.download(function (error, filename) {
                        if (!error) {
                            msg("完成", true);
                            msg("正在解压更新包……", false);
                            setTimeout(function () {
                                upd.unpack(filename, function (error, newAppPath) {
                                    if (!error) {
                                        msg("完成", true);
                                        msg("正在更新程序……", false);
                                        var dir;
                                        if (newAppPath.lastIndexOf('\\') > 0) {
                                            dir = newAppPath.substr(0, newAppPath.lastIndexOf('\\'));
                                        } else {
                                            dir = newAppPath.substr(0, newAppPath.lastIndexOf('/'));
                                        }
                                        ncp(dir, process.cwd(), function (error) {
                                            if (!error) {
                                                $("update").disabled = "";
                                                msg("完成", true);
                                                msg("程序更新完成，请点击重启按钮重启程序");
                                                $("reset").className = "";
                                                $("update").className = "hide";
                                            } else {
                                                msg("文件复制异常：请确认登录用户对当前安装目录有读写控制权限。(操作步骤：文件夹->属性->安全; 请设置当前登录用户对该安装目录有读写权限。");
                                            }
                                        });
                                    } else {
                                        msg("文件解压异常：" + error);
                                    }
                                }, manifest);
                            }, 3000)
                        } else {
                            msg("文件下载异常：" + error);
                        }
                    }, manifest);
                } else {
                    msg("目前版本已是最新");
                }
            } else {
                msg("更新服务器异常：" + error);
            }
        });
    }

    $("update").onclick = update;
    $("cancel").onclick = function () {
        window.close();
    };
    $("reset").onclick = function () {
        if (parentNW) {
            parentNW.reload();
            window.close();
        } else {
            alert("自动似乎出现了一点小问题，请手动重启" + pkg.name + "以运行最新版本");
        }
    }

    var isDownload = false;

    $("download").onclick = function () {
        if (isDownload === false) {
            isDownload = true;
            $('download-filepath-selector').click();
        }
    }

    $('download-filepath-selector').addEventListener('change', function () {
        var path = $('download-filepath-selector').value;
        if (path && path.length > 0) {
            var fs = require('fs');
            var win = gui.Window.get();
            var xhr = new XMLHttpRequest();
            win.setProgressBar(-1);
            if (process.platform == "win32") {
                xhr.open('GET', pkg.custom.winDownloadUrl, true);
            } else {
                xhr.open('GET', pkg.custom.macDownloadUrl, true);
            }
            xhr.responseType = "arraybuffer";
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    var arrayBuffer = xhr.response,
                        byteArray = new Uint8Array(arrayBuffer);
                    var buffer = new Buffer(byteArray.length);
                    for (var i = 0; i < byteArray.length; i++) {
                        buffer.writeUInt8(byteArray[i], i);
                    }
                    fs.writeFile(path, buffer, function (error) {
                        if (!error && open) {
                            gui.Shell.openItem(path);
                        }
                    });
                    win.setProgressBar(-1);
                    window.close();
                }
            };
            xhr.addEventListener("progress", function (e) {
                win.setProgressBar(e.loaded / e.total);
                setText("下载" + (e.loaded / e.total * 100).toFixed(2) + "%");
            });
            xhr.send();
            setText("开始下载");
        }
    });


</script>

</html>